#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

ynh_app_setting_set --key=password --value="$password"

#=================================================
# INSTALL DEPENDENCIES
#=================================================
ynh_script_progression "Installing nodejs..."

ynh_nodejs_install

#=================================================
# CREATE A MYSQL DATABASE
#=================================================
ynh_script_progression "Initializing MySQL database..."

echo "ALTER DATABASE $db_name CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci" | ynh_mysql_db_shell abiword_path="\"$(which abiword)\""

#=================================================
# ADD A CONFIGURATION
#=================================================
ynh_script_progression --message="Configure $app..."

abiword_path="null"
soffice_path="null"

if [[ "$export" == "abiword" ]]
then
    abiword_path="\"$(which abiword)\""
elif [[ "$export" == "libreoffice" ]]
then
    soffice_path="\"$(which soffice)\""
fi

# Use LDAP for MyPads
comment_if_ldap_disabled="//ldap_disabled"
if [ $mypads -eq 1 ] && [ $useldap -eq 1 ]
then
    comment_if_ldap_disabled=""
fi

ynh_config_add --template="settings.json" --destination="$install_dir/settings.json"
ynh_config_add --template="credentials.json" --destination="$install_dir/credentials.json"

#=================================================
# INSTALL ETHERPAD'S PLUGINS
#=================================================
ynh_script_progression "Installing Etherpad plugins..."

pushd "$install_dir"
	# Add Left/Center/Right/Justify to lines of text in a pad
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_align@${ep_align_version}
	# Framapad - Adds author names to span titles
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_author_hover@${ep_author_hover_version}
	# Framapad - Adds comments on sidebar and link it to the text.
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_comments_page@${ep_comments_page_version}
	# Framapad - Displays paragraphs, sentences, words and characters counts.
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_countable@${ep_countable_version}
	# Framapad - Delete pads which were never edited
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_delete_empty_pads@${ep_delete_empty_pads_version}
	# Framapad - Apply colors to fonts
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_font_color@${ep_font_color_version}
	# Framapad - Adds heading support to Etherpad Lite.
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_headings2@${ep_headings2_version}
	# Framapad - Edit and Export as Markdown in Etherpad
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_markdown@${ep_markdown_version}
	if [ $mypads -eq 1 ]; then
		# Framapad - Groups and private pads for Etherpad
		ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_mypads@${mypads_version}
	fi
	# Framapad - Add support to do 'Spell checking'
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_spellcheck@${ep_spellcheck_version}
	# Framapad - Add support for Subscript and Superscript
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_subscript_and_superscript@${ep_subscript_and_superscript_version}
	# Framapad - User Pad Contents font size can be set in settings, this does not effect other peoples views
	ynh_hide_warnings ynh_exec_as_app node_load_PATH npm install --no-save ep_font_size@${ep_font_size_version}
popd

#=================================================
# INSTALL ETHERPAD
#=================================================
ynh_script_progression "Installing $app..."

pushd $install_dir
 	ynh_hide_warnings ynh_exec_as_app ETHERPAD_PRODUCTION=true src/bin/installDeps.sh
popd

#=================================================
# SOME HACKS
#=================================================

if [ $mypads -eq 1 ]
then
	ynh_script_progression "Tweaking MyPad configuration..."

	# Add a link to Etherpad to allow anonymous pads creation from MyPads.
	ynh_replace --match="^ *\"DESCRIPTION\": .*</ul>" --replace="&<a href=../>Pads anonymes</a>" --file=$install_dir/node_modules/ep_mypads/static/l10n/fr.json
	ynh_replace --match="^ *\"DESCRIPTION\": .*</ul>" --replace="&<a href=../>Anonymous pads</a>" --file=$install_dir/node_modules/ep_mypads/static/l10n/en.json
	# And a link to etherpad admin from Mypads.
	ynh_replace --match="^ *\"FOOTER\": .*2.0" --replace="& | <a href='../admin'>Etherpad admin</a>" --file=$install_dir/node_modules/ep_mypads/static/l10n/en.json
	ynh_replace --match="^ *\"FOOTER\": .*2.0" --replace="& | <a href='../admin'>Etherpad admin</a>" --file=$install_dir/node_modules/ep_mypads/static/l10n/fr.json

	# Find the /div just after the field to open a pad in order to add a link to MyPads plugin.
	sed -i '157i<center><br><font size="4"><a href="./mypads/" style="text-decoration: none; color: #555">MyPads</a></font></center>' $install_dir/src/templates/index.html
fi

#=================================================
# SETUP SYSTEMD
#=================================================
ynh_script_progression "Configuring systemd service..."

ynh_config_add_systemd

yunohost service add $app --description="Collaborative editor" --log="/var/log/$app/etherpad.log"

ynh_config_add_logrotate

ynh_config_add_fail2ban --logpath="/var/log/nginx/$domain-access.log" --failregex="<HOST> .* .POST /mypads/api/auth/login HTTP/1.1. 400"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting systemd service..."

ynh_systemctl --service=$app --action=restart --wait_until="You can access your Etherpad instance at" --log_path="/var/log/$app/etherpad.log" --timeout="120"

if [ $mypads -eq 1 ]
then
	ynh_replace --match="__LANGUAGE__" --replace="$language" --file="../conf/lang_mypads.sql"
	ynh_mysql_db_shell < "../conf/lang_mypads.sql"

	# Wait for etherpad to be fully started
	ynh_systemctl --action=restart --wait_until="You can access your Etherpad instance at" --log_path="/var/log/$app/etherpad.log" --timeout="120"
fi

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Installation of $app completed"
